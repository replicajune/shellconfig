name: Shellcheck

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - name: clone
        uses: actions/checkout@v1
      - name: install
        run: |
          sudo apt-get -qqq update &> /dev/null
          sudo apt-get -qqq -y install --no-install-recommends shellcheck
      - name: lint
        run: |
          while IFS= read -r -d '' SHFILE; do
            if ! head -1 "${SHFILE}" | grep -Fq '#!/usr/bin/env zsh'; then
              shellcheck --external-sources --format=gcc --color=always \
                --exclude=SC1090,SC2039,SC3037,SC3043,SC1091 "${SHFILE}" || ERROR=1
            fi
          done  < <(find . -name "*.sh" -type f -print0)
          [ -n "${ERROR}" ] && exit 1

          # SC1090: https://github.com/koalaman/shellcheck/wiki/SC1090
          # - most tests in a CI job would miss the location of an expected
          #   file on target
          # SC2039SC3037,SC3043 : https://github.com/koalaman/shellcheck/wiki/SC2039
          # - using "local", echo flags, ect.. works on at least alpine and
          #   openwrt, if busybox is safe, this is enough for me.
